/* anime-bracket 2016-01-10 */
!function(){var a=!1,b=null,c="checked",d="/me/image/upload/",e="/me/image/crop/";CROPPER_PADDING=3,ACCEPTED_FORMATS=["image/jpeg","image/gif","image/png"],cropCoords={},changeImageClick=function(){a||initCropper(),b.fadeIn()},displayMessage=function(a,b){$(".message").html(a).removeClass("hidden error success").addClass(b?"success":"error"),$(window).scrollTop(0)},initCropper=function(){var c={aspectRatio:1,minSize:[150,150],onSelect:selectionUpdated},d=0;getImageDimensions().done(function(e){e.width<e.height?(d=(e.height-e.width-2*CROPPER_PADDING)/2,d=0>d?0:d,c.setSelect=[CROPPER_PADDING,d,e.width-2*CROPPER_PADDING,d+e.width]):(d=(e.width-e.height-2*CROPPER_PADDING)/2,d=0>d?0:d,c.setSelect=[d,CROPPER_PADDING,d+e.height,e.height-2*CROPPER_PADDING]),b.find("img").Jcrop(c),a=!0})},uploadComplete=function(c){c.success?(a=!1,b.find(".crop").empty().append('<img src="'+c.fileName+'" />'),initCropper()):alert(c.message)},selectionUpdated=function(a){cropCoords=a},submitNominee=function(a){a.preventDefault();var b=$("form"),c=b.serialize(),d=$(a.target).val()?"ignore=true":"";d&&(d=(c.length?"&":"")+d,c+=d),$.ajax({url:b.attr("action"),data:c,dataType:"json",type:"POST"}).done(function(a){a.success?($("#content").html(Templates["views/admin/nominee"](a)),renderComplete(),displayMessage(a.message,!0)):displayMessage(a.message,!1)}).fail(function(){displayMessage("There was an error sending to the server",!1)})},ignoreCheck=function(a){var b=$(a.target).closest("tr");a.target.checked?(b.addClass(c),b.find("label.button").text("Not Duplicate")):(b.removeClass(c),b.find("label.button").text("Is Duplicate"))},submitCrop=function(a){a.preventDefault();var c=b.find("img").attr("src");$.ajax({url:e,type:"POST",dataType:"json",data:{imageFile:c,x:cropCoords.x,y:cropCoords.y,width:cropCoords.w,height:cropCoords.h}}).done(function(a){a.success?($(".nominee .image img").attr("src",a.fileName),$('[name="imageFile"]').val(a.fileName),b.fadeOut()):alert(a.message)}).fail(function(){alert("Unable to crop image")})},uploadChange=function(a){var b=new XMLHttpRequest,c=a.target.files,e="",f=new FormData;if(c.length>0){if(e=c[0],-1===ACCEPTED_FORMATS.indexOf(e.type))return void alert("Image must be a JPEG, GIF, or PNG");b.addEventListener("readystatechange",function(){if(4===b.readyState)try{uploadComplete(JSON.parse(b.responseText))}catch(a){}}),b.open("POST",d,!0),b.setRequestHeader("X-FileName",e.name),f.append("upload",e),b.send(f)}},copyCharacterClick=function(a){var b=$(a.currentTarget);$('[name="name"]').val(b.data("name")),$('[name="source"]').val(b.data("source")),$('[name="imageFile"]').val(b.data("image")),$(".image img").attr("src",b.data("image"))},getImageDimensions=function(){var a=new Image,c=$.Deferred(),d=b.find("img").attr("src");return a.onload=function(){c.resolve({width:a.width,height:a.height})},a.src=d,c.promise()},renderComplete=function(){b=$(".overlay"),a=!1},init=function(){$("body").on("click","#changeImage",changeImageClick).on("change",'[name="upload"]',uploadChange).on("click",".crop-submit",submitCrop).on("change",'input[type="checkbox"]',ignoreCheck).on("click",".buttons button",submitNominee).on("click","button.copy",copyCharacterClick).on("click","button.same",submitNominee),renderComplete()},init()}();